<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Pedido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="modificar-pedido.css">
</head>
<body>
    <div id="dynamic-header-container"></div>
    
    <main class="container my-5">
        <div class="row">
            <aside class="col-lg-3">
                <div class="p-3 bg-light rounded shadow-sm sticky-top" style="top: 2rem;">
                    <h4 class="text-primary">DETALLE DE PEDIDO</h4>
                    <p class="text-muted small">Revisa tu selección y confirma tu pedido.</p>
                    <hr>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="enviarPedido()">Confirmar Pedido</button>
                        <button class="btn btn-primary" onclick="modificarSeleccion()">Modificar Selección</button>
                        <button class="btn btn-danger" onclick="eliminarPedidoCompleto()">Eliminar Todo</button>
                    </div>
                </div>
            </aside>
            <div class="col-lg-9">
                <div class="p-4 mb-4 bg-light rounded-3 banner">
                    <h2 class="display-6">Resumen de tu selección en progreso</h2>
                </div>
                <div class="pedido-container" id="detalle-pedido-container"></div>
            </div>
        </div>
    </main>
    
    <script src="../components/navbar-empleado.js"></script> 
    <script src="../components/navbar-usuario.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadDynamicHeader();
            mostrarPedidoAgrupado();
        });

        function loadDynamicHeader() {
            const rol = localStorage.getItem('rol');
            const headerContainer = document.getElementById('dynamic-header-container');
            
            if (rol === 'EMPLEADO') {
                headerContainer.innerHTML = '<employee-header></employee-header>';
            } else if (rol === 'USUARIO') {
                headerContainer.innerHTML = '<user-header></user-header>';
            } else {
                headerContainer.innerHTML = '<main-header></main-header>';
            }
        }

        // Enviar pedido (soporta EXPRESS y SEMANAL)
        async function enviarPedido() {
            const pedidoGuardadoJSON = localStorage.getItem('pedidoActual');
            const usuarioStr = localStorage.getItem('usuario');
            if (!pedidoGuardadoJSON || !usuarioStr) return;

            const usuario = JSON.parse(usuarioStr);
            const items = Object.values(JSON.parse(pedidoGuardadoJSON));
            if (items.length === 0) return;

            const tipoPedido = items[0].tipo || 'SEMANAL';
            let endpoint, payload;

            if (tipoPedido === 'EXPRESS') {
                endpoint = 'http://localhost:3000/api/usuario/pedido-personal';
                payload = {
                    id_usuario: usuario.id,
                    detalles: items.map(i => ({ id_item_menu: i.id, cantidad: i.cantidad }))
                };
            } else {
                endpoint = 'http://localhost:3000/api/pedido';
                
                // === CORRECCIÓN CRÍTICA ===
                // Obtenemos la semana del menú que visualizó el usuario en el Home
                // en lugar de calcular la semana del calendario.
                const semanaGuardada = localStorage.getItem('semanaMenuActual');
                
                // Si no hay semana guardada, asumimos 1 por defecto para evitar errores
                const semanaActual = semanaGuardada ? parseInt(semanaGuardada) : 1;
                // ==========================

                payload = {
                    id_usuario: usuario.id,
                    semana: semanaActual, 
                    detalles: items.map(i => ({ id_item_menu: i.id, cantidad: i.cantidad, id_dia: i.id_dia }))
                };
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || "Error al confirmar");
                }

                const data = await response.json();
                alert(`Pedido ${tipoPedido} confirmado! ID: ${data.pedidoId}`);
                localStorage.removeItem('pedidoActual');

                // Redirigir al historial unificado (ambos tipos)
                window.location.href = '../historial/historial.html';

            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }
        
        // Mostrar resumen agrupado (incluye EXPRESS)
        function mostrarPedidoAgrupado() {
            const pedidoContainer = document.getElementById("detalle-pedido-container");
            const pedidoGuardadoJSON = localStorage.getItem('pedidoActual');

            if (!pedidoGuardadoJSON || Object.keys(JSON.parse(pedidoGuardadoJSON)).length === 0) {
                pedidoContainer.innerHTML = "<div class='alert alert-info'>No tienes ningún pedido en progreso. Ve a 'Inicio' para comenzar a seleccionar platos.</div>";
                const confirmarBtn = document.querySelector('button.btn-success');
                if (confirmarBtn) confirmarBtn.disabled = true;
                return;
            }
            
            const pedidoGuardado = JSON.parse(pedidoGuardadoJSON);
            const itemsDelPedido = Object.values(pedidoGuardado);

            const pedidoAgrupado = {};
            itemsDelPedido.forEach(item => {
                const dia = item.nombre_dia || 'EXPRESS';
                if (!pedidoAgrupado[dia]) pedidoAgrupado[dia] = [];
                pedidoAgrupado[dia].push(item);
            });

            let cardsHtml = "";
            const ordenDias = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'EXPRESS', 'CAT', 'PEDIDO'];

            ordenDias.forEach(dia => {
                if (pedidoAgrupado[dia] && pedidoAgrupado[dia].length > 0) {
                    const nombreDia = (dia === 'CAT' || dia === 'PEDIDO') ? 'ITEMS SELECCIONADOS' : (dia === 'EXPRESS' ? 'EXPRESS / PEDIDO PERSONAL' : dia.charAt(0).toUpperCase() + dia.slice(1).toLowerCase());
                    cardsHtml += `<h4 class="mt-4 border-bottom pb-2">${nombreDia}</h4>`;
                    
                    pedidoAgrupado[dia].forEach(item => {
                        const claveUnica = item.claveUnica || item.key || item.clave || item.id;
                        const imgSrc = item.imagen_url && (item.imagen_url.startsWith('http://') || item.imagen_url.startsWith('https://')) ? item.imagen_url : (item.imagen_url ? `../img/${item.imagen_url.split('/').pop()}` : '../img/default_plato.jpg');
                        cardsHtml += `
                            <div class="card mb-3 shadow-sm">
                                <div class="card-body d-flex align-items-center">
                                    <img src="${imgSrc}" alt="${item.nombre}" onerror="this.src='../img/default_plato.jpg'" class="img-fluid rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title mb-0">${item.nombre}</h6>
                                        <small class="text-muted">${item.categoria || ''}</small>
                                    </div>
                                    <div class="fw-bold me-3">Cantidad: ${Number(item.cantidad) || 0}</div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarItem(${item.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                    </button>
                                </div>
                            </div>`;
                    });
                }
            });
            pedidoContainer.innerHTML = cardsHtml;
        }

        function eliminarItem(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este plato del pedido?')) return;
            const pedidoGuardado = JSON.parse(localStorage.getItem('pedidoActual') || '{}');

            const claveReal = Object.keys(pedidoGuardado).find(k => pedidoGuardado[k].id == id);
            if (!claveReal) {
                console.warn("No se encontró la clave del item.", pedidoGuardado);
                return;
            }

            delete pedidoGuardado[claveReal];
            localStorage.setItem('pedidoActual', JSON.stringify(pedidoGuardado));
            mostrarPedidoAgrupado();
        }

        function modificarSeleccion() {
            const rol = localStorage.getItem('rol');
            const destino = rol === 'USUARIO' ? '../perfil-usuario/perfil-usuario.html' : '../home/home.html';
            window.location.href = destino;
        }

        function eliminarPedidoCompleto() {
            if (confirm('¿Desea eliminar su pedido completo? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('pedidoActual');
                mostrarPedidoAgrupado();
                alert('Pedido eliminado con éxito.');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>